name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '30.1'

      - name: Check syntax
        run: |
          emacs -Q --batch \
            --eval "(dolist (f (append (file-expand-wildcards \"lisp/*.el\")
                                       '(\"early-init.el\" \"init.el\")))
                      (message \"Checking %s...\" f)
                      (find-file f)
                      (check-parens))"

      - name: Byte-compile
        run: |
          cat > /tmp/ci-check.el << 'EOF'
          ;; Add lisp dir to load path for local requires
          (add-to-list 'load-path (expand-file-name "lisp"))

          ;; Load built-in packages needed for compilation
          (require 'project)

          ;; Stub macros for external packages
          (defmacro use-package (name &rest args) nil)
          (defmacro general-create-definer (name &rest args)
            `(defmacro ,name (&rest bindings) nil))
          (defmacro general-define-key (&rest args) nil)
          (defmacro evil-define-key* (&rest args) nil)

          ;; Stub functions
          (defun straight-use-package (&rest _))

          ;; Provide stubbed features
          (provide 'use-package)
          (provide 'general)
          (provide 'evil)
          (provide 'straight)

          ;; Compile settings
          (setq byte-compile-warnings '(not free-vars unresolved docstrings))

          ;; Compile all files (skip init.el as it only contains requires)
          (let ((files (append (file-expand-wildcards "lisp/*.el")
                               '("early-init.el")))
                (failed nil))
            (dolist (f files)
              (princ (format "Compiling %s..." f))
              (if (byte-compile-file f)
                  (princ " OK\n")
                (princ " FAILED\n")
                (setq failed t)))
            (if failed
                (kill-emacs 1)
              (princ "All files compiled successfully\n")))
          EOF
          emacs -Q --batch -l /tmp/ci-check.el
